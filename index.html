<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Tính chi phí Vật tư Điện</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8T0EWJ4KCQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-8T0EWJ4KCQ');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện để xuất PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Thư viện để kéo/thả -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .table-row-animation {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 1rem;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #cce5ff;
        }
        .handle {
            cursor: move;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto">
        <div id="main-content" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Công cụ Tính chi phí Vật tư & Nhân công</h1>
                <p class="text-slate-500 mt-2">Tra cứu vật tư, thêm tùy chỉnh, lưu trữ và xuất báo giá ra file CSV/PDF.</p>
            </div>

            <!-- Tên dự án -->
            <div class="mb-6">
                <label for="projectName" class="block text-sm font-medium text-slate-700 mb-2">Tên Dự án / Báo giá</label>
                <input type="text" id="projectName" class="w-full px-4 py-3 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ví dụ: Báo giá nhà anh A - Hạng mục điện">
            </div>

            <!-- Trạng thái tải dữ liệu -->
            <div id="data-status" class="text-center mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-800 transition-opacity duration-500">
                Đang tải cơ sở dữ liệu vật tư...
            </div>

            <!-- Form thêm vật tư -->
            <form id="itemForm">
                <fieldset id="form-fieldset" class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-4" disabled>
                    <input type="hidden" id="editIndex" value="-1">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="itemFullName" class="block text-sm font-medium text-slate-700 mb-2">Tìm kiếm vật tư</label>
                            <input type="text" id="itemFullName" list="itemOptions" class="w-full px-4 py-3 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Gõ để tìm kiếm...">
                            <datalist id="itemOptions"></datalist>
                        </div>
                         <div>
                            <label for="itemName" class="block text-sm font-medium text-slate-700 mb-2">Tên vật tư <span class="text-red-500">*</span></label>
                            <input type="text" id="itemName" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                        <div>
                            <label for="itemSpec" class="block text-sm font-medium text-slate-700 mb-2">Quy cách</label>
                            <input type="text" id="itemSpec" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                         <div>
                            <label for="itemBrand" class="block text-sm font-medium text-slate-700 mb-2">Nhãn hiệu</label>
                            <input type="text" id="itemBrand" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                        <div>
                            <label for="itemUnit" class="block text-sm font-medium text-slate-700 mb-2">Đơn vị</label>
                            <input type="text" id="itemUnit" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" placeholder="m, cái..." readonly>
                        </div>
                        <div>
                            <label for="itemQuantity" class="block text-sm font-medium text-slate-700 mb-2">Số lượng <span class="text-red-500">*</span></label>
                            <input type="number" step="0.1" id="itemQuantity" class="w-full px-4 py-3 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="100" required>
                        </div>
                         <div>
                            <label for="itemMaterialPrice" class="block text-sm font-medium text-slate-700 mb-2">ĐG Vật tư</label>
                            <input type="number" id="itemMaterialPrice" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                         <div>
                            <label for="itemLaborPrice" class="block text-sm font-medium text-slate-700 mb-2">ĐG Nhân công</label>
                            <input type="number" id="itemLaborPrice" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                    </div>
                     <div class="pt-2 flex justify-between items-center">
                        <div class="flex items-center">
                            <input id="customEntry" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="customEntry" class="ml-2 block text-sm text-gray-900">Nhập tùy chỉnh</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" id="cancelEditBtn" class="hidden bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600">Hủy</button>
                            <button type="submit" id="submitBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out inline-flex items-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                                <span id="submitBtnText">Thêm Vật tư</span>
                            </button>
                        </div>
                    </div>
                    <div class="border-t border-slate-300 pt-4 mt-4 flex items-center space-x-2">
                        <input type="text" id="categoryName" class="flex-grow px-4 py-2 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Tên hạng mục mới...">
                        <button type="button" id="addCategoryBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 inline-flex items-center">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3ZM2 7.5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1ZM2 12a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1Z" /></svg>
                            Thêm Hạng mục
                        </button>
                    </div>
                </fieldset>
            </form>

            <!-- Vùng hiển thị danh sách và kết quả -->
            <div id="result-container" class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-semibold text-slate-800">Bảng dự toán chi phí</h2>
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-500">Dự án:</p>
                        <p id="displayProjectName" class="text-lg font-semibold text-slate-800">Chưa có tên</p>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-slate-200 rounded-lg">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">STT</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tên vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Quy cách</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nhãn hiệu</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐV</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SL</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐG Vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐG Nhân công</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Thành tiền</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider action-column">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="itemListBody" class="divide-y divide-slate-200">
                           <tr id="emptyRow">
                                <td colspan="10" class="text-center text-slate-500 p-6">
                                    Chưa có vật tư nào được thêm.
                                </td>
                           </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 flex justify-end items-start bg-slate-100 p-4 rounded-lg">
                    <div class="flex items-start space-x-8">
                        <div>
                            <label for="vatRate" class="block text-sm font-medium text-slate-700 mb-2">Thuế suất VAT (%)</label>
                            <input type="number" id="vatRate" class="w-32 px-4 py-2 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500" value="10">
                        </div>
                        <div class="text-right space-y-2 min-w-[300px]">
                            <div class="flex justify-between items-center">
                                <p class="text-sm font-medium text-slate-600 mr-4">Tổng chi phí vật tư:</p>
                                <p id="totalMaterialCost" class="text-base font-semibold text-slate-800">0 VNĐ</p>
                            </div>
                             <div class="flex justify-between items-center">
                                <p class="text-sm font-medium text-slate-600 mr-4">Tổng chi phí nhân công:</p>
                                <p id="totalLaborCost" class="text-base font-semibold text-slate-800">0 VNĐ</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-sm font-medium text-slate-600 mr-4">Tổng cộng trước thuế:</p>
                                <p id="subTotalCost" class="text-base font-semibold text-slate-800">0 VNĐ</p>
                            </div>
                             <div class="flex justify-between items-center">
                                <p class="text-sm font-medium text-slate-600 mr-4">Tiền thuế GTGT (VAT):</p>
                                <p id="vatAmount" class="text-base font-semibold text-slate-800">0 VNĐ</p>
                            </div>
                            <div class="border-t border-slate-300 my-1"></div>
                             <div class="flex justify-between items-center">
                                <p class="text-base font-bold text-slate-900 mr-4">TỔNG CỘNG CUỐI CÙNG:</p>
                                <p id="totalCost" class="text-2xl font-bold text-blue-600">0 VNĐ</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <p class="text-center mt-4 text-sm font-semibold text-slate-600">Lưu ý: Đơn giá vật tư & nhân công chưa bao gồm thuế giá trị gia tăng (VAT).</p>
            </div>
            
            <!-- Nút xuất file -->
            <div class="mt-6 flex items-center justify-between">
                <button id="clearListBtn" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all duration-300 ease-in-out inline-flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                   <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.157.234-2.13.84-2.825 1.697A3.5 3.5 0 0 0 2.5 9.5v.053c0 .856.34 1.633.89 2.211a3.5 3.5 0 0 0 5.22 0 3.5 3.5 0 0 0 .89-2.211V9.5a3.5 3.5 0 0 0-.675-2.009A3.499 3.499 0 0 0 6 4.193V3.75A1.25 1.25 0 0 1 7.25 2.5h5.5A1.25 1.25 0 0 1 14 3.75v.443a3.5 3.5 0 0 0-2.175 2.009A3.5 3.5 0 0 0 11.15 9.5v.053c0 .856.34 1.633.89 2.211a3.5 3.5 0 0 0 5.22 0 3.5 3.5 0 0 0 .89-2.211V9.5a3.5 3.5 0 0 0-.675-2.009A3.499 3.499 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 15a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" clip-rule="evenodd" /></svg>
                   Xóa hết danh sách
                </button>
                <div class="flex items-center space-x-4">
                     <button id="exportPdfBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out inline-flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                       <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H5Zm0 2h10v12H5V4ZM9.5 7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V7.5a.5.5 0 0 1 .5-.5Zm-2 3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 1 .5-.5Zm4-3a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-1 0v-5a.5.5 0 0 1 .5-.5Z" clip-rule="evenodd" /></svg>
                       Xuất ra file PDF
                    </button>
                    <button id="exportCsvBtn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 ease-in-out inline-flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                       <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                       </svg>
                       Xuất ra file CSV
                    </button>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-slate-500 space-y-2">
            <div id="user-level-display" class="font-semibold text-slate-600"></div>
            <button id="manageDataBtn" class="text-blue-600 hover:underline">Quản lý dữ liệu tùy chỉnh</button>
             <div class="pt-2 border-t border-slate-200">
                <p>Mọi phản hồi hoặc nhu cầu đăng ký mã khóa, vui lòng liên hệ:</p>
                <a href="mailto:hocthuoclong2k@gmail.com" class="font-semibold text-blue-600 hover:underline">hocthuoclong2k@gmail.com</a>
            </div>
           
        </footer>
    </div>
    
    <!-- Modal Nhập Mã Khóa -->
    <div id="keyModal" class="modal flex">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-4">Nhập Mã Khóa</h2>
            <p class="text-slate-600 mb-4">Vui lòng nhập mã khóa để sử dụng đầy đủ tính năng. Hoặc tiếp tục với bản miễn phí (giới hạn 10 vật tư).</p>
            <input type="text" id="keyInput" class="w-full px-4 py-3 mb-4 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nhập mã khóa của bạn...">
            <p id="keyError" class="text-red-500 text-sm mb-4 hidden">Mã khóa không hợp lệ. Vui lòng thử lại.</p>
            <div class="flex justify-center space-x-4">
                <button id="submitKeyBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Xác nhận</button>
                <button id="freeTrialBtn" class="bg-gray-200 text-slate-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Dùng bản miễn phí</button>
            </div>
        </div>
    </div>

    <!-- Modal Quản lý Dữ liệu -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Quản lý Vật tư Tùy chỉnh</h2>
                <button id="closeModalBtn" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="customDataList" class="max-h-96 overflow-y-auto">
                <!-- Danh sách vật tư tùy chỉnh sẽ được thêm vào đây -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- CÁC BIẾN TOÀN CỤC ---
            const dataStatus = document.getElementById('data-status');
            const formFieldset = document.querySelector('#itemForm fieldset');
            const itemForm = document.getElementById('itemForm');
            const projectNameInput = document.getElementById('projectName');
            const displayProjectName = document.getElementById('displayProjectName');
            const itemFullNameInput = document.getElementById('itemFullName');
            const itemNameInput = document.getElementById('itemName');
            const itemSpecInput = document.getElementById('itemSpec');
            const itemBrandInput = document.getElementById('itemBrand');
            const itemUnitInput = document.getElementById('itemUnit');
            const itemMaterialPriceInput = document.getElementById('itemMaterialPrice');
            const itemLaborPriceInput = document.getElementById('itemLaborPrice');
            const itemQuantityInput = document.getElementById('itemQuantity');
            const itemOptions = document.getElementById('itemOptions');
            const itemListBody = document.getElementById('itemListBody');
            const totalMaterialCostEl = document.getElementById('totalMaterialCost');
            const totalLaborCostEl = document.getElementById('totalLaborCost');
            const subTotalCostEl = document.getElementById('subTotalCost');
            const vatRateInput = document.getElementById('vatRate');
            const vatAmountEl = document.getElementById('vatAmount');
            const totalCostEl = document.getElementById('totalCost');
            const emptyRow = document.getElementById('emptyRow');
            const customEntryCheckbox = document.getElementById('customEntry');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const clearListBtn = document.getElementById('clearListBtn');
            const editIndexInput = document.getElementById('editIndex');
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const manageDataBtn = document.getElementById('manageDataBtn');
            const dataModal = document.getElementById('dataModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const customDataList = document.getElementById('customDataList');
            const keyModal = document.getElementById('keyModal');
            const keyInput = document.getElementById('keyInput');
            const submitKeyBtn = document.getElementById('submitKeyBtn');
            const freeTrialBtn = document.getElementById('freeTrialBtn');
            const keyError = document.getElementById('keyError');
            const userLevelDisplay = document.getElementById('user-level-display');
            const categoryNameInput = document.getElementById('categoryName');
            const addCategoryBtn = document.getElementById('addCategoryBtn');

            let addedItems = [];
            let itemPriceData = {};
            let keyData = {};
            let userLevel = 'Free';
            let itemLimit = 10;
            const allInputs = [itemNameInput, itemSpecInput, itemBrandInput, itemUnitInput, itemMaterialPriceInput, itemLaborPriceInput];
            const LOCAL_STORAGE_KEY_CUSTOM = 'customUnitPriceData';
            const LOCAL_STORAGE_KEY_LICENSE = 'userLicenseKey';
            const LOCAL_STORAGE_KEY_QUOTE = 'currentQuoteItems';
            const LOCAL_STORAGE_KEY_PROJECT = 'currentProjectName';

            // --- CÁC HÀM XỬ LÝ ---

            function getCustomData() {
                return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_CUSTOM) || '{}');
            }

            function saveCustomData(data) {
                localStorage.setItem(LOCAL_STORAGE_KEY_CUSTOM, JSON.stringify(data));
            }

            function saveCurrentQuote() {
                localStorage.setItem(LOCAL_STORAGE_KEY_QUOTE, JSON.stringify(addedItems));
                localStorage.setItem(LOCAL_STORAGE_KEY_PROJECT, projectNameInput.value);
            }

            function loadCurrentQuote() {
                const savedItems = localStorage.getItem(LOCAL_STORAGE_KEY_QUOTE);
                const savedProject = localStorage.getItem(LOCAL_STORAGE_KEY_PROJECT);
                if (savedItems) {
                    addedItems = JSON.parse(savedItems);
                }
                if (savedProject) {
                    projectNameInput.value = savedProject;
                }
            }
            
            function populateDatalist() {
                itemOptions.innerHTML = '';
                Object.keys(itemPriceData).sort().forEach(itemName => {
                    const option = document.createElement('option');
                    option.value = itemName;
                    itemOptions.appendChild(option);
                });
            }
            
            function updateUserLevelDisplay() {
                const limitText = itemLimit === Infinity ? 'Không giới hạn' : itemLimit;
                const itemCount = addedItems.filter(item => item.type === 'item').length;
                userLevelDisplay.innerHTML = `
                    <span>Cấp độ: ${userLevel} (${itemCount}/${limitText} vật tư)</span>
                    <button id="logoutBtn" class="text-red-500 hover:underline ml-2">(Đăng xuất)</button>
                `;
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if(confirm('Bạn có chắc muốn đăng xuất và nhập mã khóa mới?')) {
                        localStorage.removeItem(LOCAL_STORAGE_KEY_LICENSE);
                        location.reload();
                    }
                });
            }

            function setUserLevel(levelDetails) {
                if(!levelDetails) { // Free user
                    userLevel = 'Free';
                    itemLimit = 10;
                } else {
                    userLevel = levelDetails.name;
                    itemLimit = levelDetails.limit === 5000 ? Infinity : levelDetails.limit;
                }
                updateUserLevelDisplay();
                keyModal.style.display = 'none';
                initializeApp(); // Khởi động phần còn lại của app
            }

            async function handleAuthentication() {
                 try {
                    const response = await fetch('key/keylevel.json');
                    if (!response.ok) throw new Error('Không tìm thấy file key.');
                    keyData = await response.json();

                    const savedKey = localStorage.getItem(LOCAL_STORAGE_KEY_LICENSE);
                    let foundLevel = null;
                    if(savedKey) {
                        for (const level of Object.values(keyData)) {
                             if (level.keys.some(k => k.code === savedKey)) {
                                const keyInfo = level.keys.find(k => k.code === savedKey);
                                const now = new Date();
                                const start = new Date(keyInfo.startDate);
                                const end = new Date(keyInfo.endDate);
                                now.setHours(0,0,0,0); // So sánh ngày, bỏ qua giờ
                                
                                if (now >= start && now <= end) {
                                    foundLevel = level;
                                }
                                break;
                            }
                        }
                    }

                    if (foundLevel) {
                        setUserLevel(foundLevel);
                    } else {
                        localStorage.removeItem(LOCAL_STORAGE_KEY_LICENSE); // Xóa key cũ nếu không hợp lệ
                        keyModal.style.display = 'flex';
                    }
                } catch (e) {
                    console.error(e);
                    setUserLevel(null);
                }
            }
            
            submitKeyBtn.addEventListener('click', () => {
                const enteredKey = keyInput.value.trim();
                let foundLevel = null;
                let keyInfo = null;

                for (const level of Object.values(keyData)) {
                    const foundKeyInfo = level.keys.find(k => k.code === enteredKey);
                    if (foundKeyInfo) {
                        foundLevel = level;
                        keyInfo = foundKeyInfo;
                        break;
                    }
                }

                if (foundLevel && keyInfo) {
                    const now = new Date();
                    const start = new Date(keyInfo.startDate);
                    const end = new Date(keyInfo.endDate);
                    now.setHours(0,0,0,0);

                    if (now < start) {
                        keyError.textContent = `Mã khóa sẽ có hiệu lực từ ngày ${start.toLocaleDateString('vi-VN')}.`;
                        keyError.classList.remove('hidden');
                    } else if (now > end) {
                        keyError.textContent = `Mã khóa đã hết hạn vào ngày ${end.toLocaleDateString('vi-VN')}.`;
                        keyError.classList.remove('hidden');
                    } else {
                        localStorage.setItem(LOCAL_STORAGE_KEY_LICENSE, enteredKey);
                        keyError.classList.add('hidden');
                        setUserLevel(foundLevel);
                    }
                } else {
                    keyError.textContent = 'Mã khóa không hợp lệ. Vui lòng thử lại.';
                    keyError.classList.remove('hidden');
                }
            });

            freeTrialBtn.addEventListener('click', () => {
                localStorage.removeItem(LOCAL_STORAGE_KEY_LICENSE);
                setUserLevel(null);
            });


            async function initializeApp() {
                try {
                    // Tải nhiều file unitprice
                    let baseData = {};
                    let i = 0;
                    while (true) {
                        const fileName = i === 0 ? 'unitprice.json' : `unitprice-${i}.json`;
                        const response = await fetch(fileName);
                        if (!response.ok) {
                            if (response.status === 404) {
                                break; // Dừng lại khi không tìm thấy file tiếp theo
                            }
                            throw new Error(`HTTP error! status: ${response.status} for file ${fileName}`);
                        }
                        const dataPart = await response.json();
                        baseData = { ...baseData, ...dataPart };
                        i++;
                    }

                    const customData = getCustomData();
                    itemPriceData = { ...baseData, ...customData };
                    
                    populateDatalist();

                    dataStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                    dataStatus.classList.add('bg-green-100', 'text-green-800');
                    dataStatus.textContent = 'Cơ sở dữ liệu đã sẵn sàng.';
                    formFieldset.disabled = false;
                    setTimeout(() => { dataStatus.style.opacity = 0; }, 2000);

                } catch (error) {
                    console.error('Lỗi khi tải file dữ liệu:', error);
                    dataStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                    dataStatus.classList.add('bg-red-100', 'text-red-800');
                    dataStatus.innerHTML = `<strong>Lỗi: Không thể tải được cơ sở dữ liệu.</strong><br>${error.message}.<br>Nếu bạn đang mở file này trực tiếp, hãy thử chạy nó qua một máy chủ web cục bộ.`;
                }
            }

            function setEditMode(isEditing) {
                if (isEditing) {
                    submitBtnText.textContent = 'Cập nhật';
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                    cancelEditBtn.classList.remove('hidden');
                    itemFullNameInput.required = false;
                } else {
                    submitBtnText.textContent = 'Thêm Vật tư';
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                    cancelEditBtn.classList.add('hidden');
                    editIndexInput.value = '-1';
                    itemForm.reset();
                    customEntryCheckbox.checked = false;
                    customEntryCheckbox.dispatchEvent(new Event('change'));
                    itemFullNameInput.required = false;
                }
            }

            function renderList() {
                itemListBody.innerHTML = ''; 
                let grandTotalMaterial = 0;
                let grandTotalLabor = 0;
                let itemCounter = 0;

                const projectName = projectNameInput.value.trim();
                displayProjectName.textContent = projectName || 'Chưa có tên';

                const hasItems = addedItems.length > 0;
                exportCsvBtn.disabled = !hasItems;
                exportPdfBtn.disabled = !hasItems;
                clearListBtn.disabled = !hasItems;

                if (!hasItems) {
                    itemListBody.appendChild(emptyRow);
                } else {
                    addedItems.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.dataset.id = index; // For SortableJS
                        
                        if(item.type === 'category') {
                             row.className = 'bg-blue-100 font-bold';
                             row.innerHTML = `
                                <td class="px-4 py-2 handle text-blue-800" colspan="9">${item.name}</td>
                                <td class="px-4 py-2 text-center action-column">
                                    <button class="delete-btn text-red-500 hover:text-red-700" data-index="${index}"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                                </td>
                             `;
                        } else {
                            itemCounter++;
                            const materialSubtotal = item.quantity * item.materialPrice;
                            const laborSubtotal = item.quantity * item.laborPrice;
                            const totalSubtotal = materialSubtotal + laborSubtotal;
                            grandTotalMaterial += materialSubtotal;
                            grandTotalLabor += laborSubtotal;
                            
                            if (item.materialPrice === 0 || item.laborPrice === 0) {
                                row.className = 'table-row-animation bg-yellow-100 hover:bg-yellow-200';
                            } else {
                                row.className = 'table-row-animation hover:bg-slate-50';
                            }

                            row.innerHTML = `
                                <td class="px-4 py-3 text-sm text-slate-700 handle">${itemCounter}</td>
                                <td class="px-4 py-3 text-sm font-medium text-slate-900">${item.name}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.spec}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.brand}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.unit}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.quantity.toLocaleString('vi-VN')}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.materialPrice.toLocaleString('vi-VN')}</td>
                                <td class="px-4 py-3 text-sm text-slate-700">${item.laborPrice.toLocaleString('vi-VN')}</td>
                                <td class="px-4 py-3 text-sm font-semibold text-slate-900">${totalSubtotal.toLocaleString('vi-VN')}</td>
                                <td class="px-4 py-3 text-center action-column">
                                    <div class="flex justify-center items-center space-x-2">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700" data-index="${index}"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700" data-index="${index}"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                                    </div>
                                </td>
                            `;
                        }
                        itemListBody.appendChild(row);
                    });
                }
                
                const subTotal = grandTotalMaterial + grandTotalLabor;
                const vatRate = parseFloat(vatRateInput.value) || 0;
                const vatAmount = subTotal * (vatRate / 100);
                const grandTotal = subTotal + vatAmount;

                totalMaterialCostEl.textContent = `${grandTotalMaterial.toLocaleString('vi-VN')} VNĐ`;
                totalLaborCostEl.textContent = `${grandTotalLabor.toLocaleString('vi-VN')} VNĐ`;
                subTotalCostEl.textContent = `${subTotal.toLocaleString('vi-VN')} VNĐ`;
                vatAmountEl.textContent = `${vatAmount.toLocaleString('vi-VN')} VNĐ`;
                totalCostEl.textContent = `${grandTotal.toLocaleString('vi-VN')} VNĐ`;
                updateUserLevelDisplay();
                saveCurrentQuote();
            }

            // --- EVENT LISTENERS ---
            projectNameInput.addEventListener('input', renderList);
            vatRateInput.addEventListener('input', renderList);
            
            cancelEditBtn.addEventListener('click', () => setEditMode(false));

            customEntryCheckbox.addEventListener('change', function() {
                const isCustom = this.checked;
                allInputs.forEach(input => {
                    input.readOnly = !isCustom;
                    input.classList.toggle('bg-slate-200', !isCustom);
                    input.classList.toggle('bg-white', isCustom);
                    if(isCustom) input.placeholder = "Nhập...";
                });
                if (!isCustom) itemFullNameInput.dispatchEvent(new Event('input'));
            });

            itemFullNameInput.addEventListener('input', function() {
                if (customEntryCheckbox.checked) return;
                const selectedItem = itemPriceData[this.value];
                if (selectedItem) {
                    itemNameInput.value = selectedItem.name;
                    itemSpecInput.value = selectedItem.spec;
                    itemBrandInput.value = selectedItem.brand;
                    itemUnitInput.value = selectedItem.unit;
                    itemMaterialPriceInput.value = selectedItem.materialPrice;
                    itemLaborPriceInput.value = selectedItem.laborPrice;
                } else {
                    allInputs.forEach(input => input.value = '');
                }
            });

            itemForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const currentIndex = parseInt(editIndexInput.value, 10);
                const currentItemCount = addedItems.filter(item => item.type === 'item').length;
                if (currentItemCount >= itemLimit && currentIndex === -1) {
                    alert(`Bạn đã đạt đến giới hạn ${itemLimit} vật tư cho cấp độ "${userLevel}".`);
                    return;
                }

                let materialPrice = parseFloat(itemMaterialPriceInput.value);
                let laborPrice = parseFloat(itemLaborPriceInput.value);

                const item = {
                    type: 'item',
                    name: itemNameInput.value.trim(),
                    spec: itemSpecInput.value.trim(),
                    brand: itemBrandInput.value.trim(),
                    unit: itemUnitInput.value.trim(),
                    quantity: parseFloat(itemQuantityInput.value),
                    materialPrice: isNaN(materialPrice) ? 0 : materialPrice,
                    laborPrice: isNaN(laborPrice) ? 0 : laborPrice,
                };

                if (!item.name) {
                    alert("Vui lòng nhập Tên vật tư.");
                    itemNameInput.focus();
                    return;
                }
                if (isNaN(item.quantity) || item.quantity <= 0) {
                    alert("Vui lòng nhập Số lượng hợp lệ (lớn hơn 0).");
                    itemQuantityInput.focus();
                    return;
                }

                if (currentIndex > -1) {
                    addedItems[currentIndex] = item;
                } else {
                    addedItems.push(item);
                    // Lưu vật tư mới nếu là tùy chỉnh
                    if (customEntryCheckbox.checked) {
                        const customData = getCustomData();
                        const fullName = `${item.name} ${item.spec} (${item.brand})`.replace(/\s+/g, ' ').trim();
                        customData[fullName] = { ...item };
                        delete customData[fullName].quantity;
                        saveCustomData(customData);
                        itemPriceData = { ...itemPriceData, ...customData };
                        populateDatalist();
                    }
                }
                
                renderList();
                setEditMode(false);
                itemFullNameInput.focus();
            });
            
            addCategoryBtn.addEventListener('click', () => {
                const categoryName = categoryNameInput.value.trim();
                if (categoryName) {
                    addedItems.push({ type: 'category', name: categoryName });
                    renderList();
                    categoryNameInput.value = '';
                }
            });

            itemListBody.addEventListener('click', function(event) {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const index = parseInt(targetButton.dataset.index, 10);

                if (targetButton.classList.contains('delete-btn')) {
                    addedItems.splice(index, 1);
                    renderList();
                } else if (targetButton.classList.contains('edit-btn')) {
                    const item = addedItems[index];
                    
                    itemFullNameInput.value = '';
                    itemNameInput.value = item.name;
                    itemSpecInput.value = item.spec;
                    itemBrandInput.value = item.brand;
                    itemUnitInput.value = item.unit;
                    itemQuantityInput.value = item.quantity;
                    itemMaterialPriceInput.value = item.materialPrice;
                    itemLaborPriceInput.value = item.laborPrice;
                    
                    editIndexInput.value = index;
                    setEditMode(true);
                    
                    customEntryCheckbox.checked = true;
                    customEntryCheckbox.dispatchEvent(new Event('change'));

                    document.getElementById('main-content').scrollIntoView();
                }
            });
            
            clearListBtn.addEventListener('click', function() {
                if (addedItems.length > 0 && confirm('Bạn có chắc muốn xóa toàn bộ danh sách vật tư hiện tại?')) {
                    addedItems = [];
                    projectNameInput.value = '';
                    renderList();
                }
            });

            exportCsvBtn.addEventListener('click', function() {
                if (addedItems.length === 0) return;

                const projectName = projectNameInput.value.trim();
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                
                if (projectName) {
                    csvContent += `Dự án:,"${projectName.replace(/"/g, '""')}"\r\n\r\n`;
                }

                csvContent += "STT,Tên vật tư,Quy cách,Nhãn hiệu,Đơn vị,Số lượng,ĐG Vật tư,TT Vật tư,ĐG Nhân công,TT Nhân công,Tổng cộng\r\n";

                let totalMaterial = 0, totalLabor = 0;
                let itemCounter = 0;
                addedItems.forEach((item) => {
                    if (item.type === 'category') {
                        csvContent += `,"${item.name.replace(/"/g, '""')}"\r\n`;
                    } else {
                        itemCounter++;
                        const materialSub = item.quantity * item.materialPrice;
                        const laborSub = item.quantity * item.laborPrice;
                        const totalSub = materialSub + laborSub;
                        totalMaterial += materialSub;
                        totalLabor += laborSub;
                        const row = [
                            itemCounter, `"${item.name.replace(/"/g, '""')}"`, `"${item.spec.replace(/"/g, '""')}"`, `"${item.brand.replace(/"/g, '""')}"`,
                            item.unit, item.quantity, item.materialPrice, materialSub, item.laborPrice, laborSub, totalSub
                        ].join(',');
                        csvContent += row + "\r\n";
                    }
                });
                
                const subTotal = totalMaterial + totalLabor;
                const vatRate = parseFloat(vatRateInput.value) || 0;
                const vatAmount = subTotal * (vatRate / 100);
                const grandTotal = subTotal + vatAmount;

                csvContent += `\r\n,,,,,,Tổng cộng trước thuế:,${subTotal}`;
                csvContent += `\r\n,,,,,,VAT (${vatRate}%):,${vatAmount}`;
                csvContent += `\r\n,,,,,,TỔNG CỘNG CUỐI CÙNG:,${grandTotal}`;

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "bao_gia_vat_tu_chi_tiet.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            exportPdfBtn.addEventListener('click', function() {
                const element = document.getElementById('result-container');
                const projectName = projectNameInput.value.trim() || 'bao_gia';
                const filename = `Bao gia - ${projectName}.pdf`;

                // Tạm thời ẩn cột hành động
                const actionColumns = element.querySelectorAll('.action-column');
                actionColumns.forEach(col => col.style.display = 'none');

                const opt = {
                    margin:       0.5,
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
                };

                html2pdf().from(element).set(opt).save().then(() => {
                    // Hiện lại cột hành động sau khi xuất xong
                     actionColumns.forEach(col => col.style.display = '');
                });
            });
            
            // --- QUẢN LÝ DỮ LIỆU TÙY CHỈNH (MODAL) ---
            function renderCustomDataList() {
                const customData = getCustomData();
                customDataList.innerHTML = '';
                if (Object.keys(customData).length === 0) {
                    customDataList.innerHTML = '<p class="text-slate-500">Không có vật tư tùy chỉnh nào được lưu.</p>';
                    return;
                }
                const ul = document.createElement('ul');
                ul.className = 'divide-y divide-gray-200';
                Object.keys(customData).forEach(key => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center';
                    li.innerHTML = `
                        <span class="text-sm">${key}</span>
                        <button class="delete-custom-item-btn text-red-500 hover:text-red-700" data-key="${key}">Xóa</button>
                    `;
                    ul.appendChild(li);
                });
                customDataList.appendChild(ul);
            }

            manageDataBtn.addEventListener('click', () => {
                renderCustomDataList();
                dataModal.style.display = 'block';
            });

            closeModalBtn.addEventListener('click', () => {
                dataModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == dataModal) {
                    dataModal.style.display = 'none';
                }
            });

            customDataList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-custom-item-btn')) {
                    const keyToDelete = event.target.dataset.key;
                    if (confirm(`Bạn có chắc muốn xóa vật tư "${keyToDelete}" khỏi bộ nhớ?`)) {
                        const customData = getCustomData();
                        delete customData[keyToDelete];
                        saveCustomData(customData);
                        
                        // Cập nhật lại CSDL và datalist đang chạy
                        delete itemPriceData[keyToDelete];
                        populateDatalist();
                        
                        renderCustomDataList(); // Cập nhật lại danh sách trong modal
                    }
                }
            });

            new Sortable(itemListBody, {
                animation: 150,
                handle: '.handle',
                onEnd: function (evt) {
                    const item = addedItems.splice(evt.oldIndex, 1)[0];
                    addedItems.splice(evt.newIndex, 0, item);
                    renderList();
                },
            });


            // --- KHỞI TẠO ---
            handleAuthentication();
            loadCurrentQuote();
            renderList();
        });
    </script>
</body>
</html>
