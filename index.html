<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Tính chi phí Vật tư Điện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .table-row-animation {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto">
        <div id="main-content" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Công cụ Tính chi phí Vật tư & Nhân công</h1>
                <p class="text-slate-500 mt-2">Tra cứu vật tư có sẵn hoặc thêm tùy chỉnh và xuất báo giá ra file CSV.</p>
            </div>

            <!-- Trạng thái tải dữ liệu -->
            <div id="data-status" class="text-center mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-800 transition-opacity duration-500">
                Đang tải cơ sở dữ liệu vật tư...
            </div>

            <!-- Form thêm vật tư -->
            <form id="itemForm">
                <fieldset id="form-fieldset" class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-4" disabled>
                    <input type="hidden" id="editIndex" value="-1">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="itemFullName" class="block text-sm font-medium text-slate-700 mb-2">Tìm kiếm vật tư</label>
                            <input type="text" id="itemFullName" list="itemOptions" class="w-full px-4 py-3 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Gõ để tìm kiếm...">
                            <datalist id="itemOptions"></datalist>
                        </div>
                         <div>
                            <label for="itemName" class="block text-sm font-medium text-slate-700 mb-2">Tên vật tư <span class="text-red-500">*</span></label>
                            <input type="text" id="itemName" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                        <div>
                            <label for="itemSpec" class="block text-sm font-medium text-slate-700 mb-2">Quy cách</label>
                            <input type="text" id="itemSpec" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                         <div>
                            <label for="itemBrand" class="block text-sm font-medium text-slate-700 mb-2">Nhãn hiệu</label>
                            <input type="text" id="itemBrand" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                        <div>
                            <label for="itemUnit" class="block text-sm font-medium text-slate-700 mb-2">Đơn vị</label>
                            <input type="text" id="itemUnit" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" placeholder="m, cái..." readonly>
                        </div>
                        <div>
                            <label for="itemQuantity" class="block text-sm font-medium text-slate-700 mb-2">Số lượng <span class="text-red-500">*</span></label>
                            <input type="number" step="0.1" id="itemQuantity" class="w-full px-4 py-3 bg-white border-slate-300 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="100" required>
                        </div>
                         <div>
                            <label for="itemMaterialPrice" class="block text-sm font-medium text-slate-700 mb-2">ĐG Vật tư</label>
                            <input type="number" id="itemMaterialPrice" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                         <div>
                            <label for="itemLaborPrice" class="block text-sm font-medium text-slate-700 mb-2">ĐG Nhân công</label>
                            <input type="number" id="itemLaborPrice" class="w-full px-4 py-3 bg-slate-200 border-slate-300 border rounded-lg transition" readonly>
                        </div>
                    </div>
                     <div class="pt-2 flex justify-between items-center">
                        <div class="flex items-center">
                            <input id="customEntry" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="customEntry" class="ml-2 block text-sm text-gray-900">Nhập tùy chỉnh</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" id="cancelEditBtn" class="hidden bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600">Hủy</button>
                            <button type="submit" id="submitBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out inline-flex items-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                                <span id="submitBtnText">Thêm vào danh sách</span>
                            </button>
                        </div>
                    </div>
                </fieldset>
            </form>

            <!-- Vùng hiển thị danh sách và kết quả -->
            <div id="result" class="mt-8">
                <h2 class="text-xl font-semibold text-slate-800 mb-4">Bảng dự toán chi phí</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-slate-200 rounded-lg">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">STT</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tên vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Quy cách</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nhãn hiệu</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐV</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SL</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐG Vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ĐG Nhân công</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Thành tiền</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="itemListBody" class="divide-y divide-slate-200">
                           <tr id="emptyRow">
                                <td colspan="10" class="text-center text-slate-500 p-6">
                                    Chưa có vật tư nào được thêm.
                                </td>
                           </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 flex justify-between items-start bg-slate-100 p-4 rounded-lg">
                    <div>
                        <button id="exportCsvBtn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 ease-in-out inline-flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                           <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                           </svg>
                           Xuất ra file CSV
                        </button>
                    </div>
                    <div class="text-right space-y-2">
                        <div class="flex justify-between items-center">
                            <p class="text-sm font-medium text-slate-600 mr-4">Tổng chi phí vật tư:</p>
                            <p id="totalMaterialCost" class="text-lg font-semibold text-slate-800">0 VNĐ</p>
                        </div>
                         <div class="flex justify-between items-center">
                            <p class="text-sm font-medium text-slate-600 mr-4">Tổng chi phí nhân công:</p>
                            <p id="totalLaborCost" class="text-lg font-semibold text-slate-800">0 VNĐ</p>
                        </div>
                        <div class="border-t border-slate-300 my-1"></div>
                         <div class="flex justify-between items-center">
                            <p class="text-base font-bold text-slate-900 mr-4">TỔNG CỘNG:</p>
                            <p id="totalCost" class="text-2xl font-bold text-blue-600">0 VNĐ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-slate-500 space-y-1">
            <p>Một công cụ đơn giản được tạo bởi Gemini.</p>
            <p class="font-semibold text-slate-600">Lưu ý: Tất cả đơn giá trên chưa bao gồm thuế giá trị gia tăng (VAT).</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- CÁC BIẾN TOÀN CỤC ---
            const dataStatus = document.getElementById('data-status');
            const formFieldset = document.querySelector('#itemForm fieldset');
            const itemForm = document.getElementById('itemForm');
            const itemFullNameInput = document.getElementById('itemFullName');
            const itemNameInput = document.getElementById('itemName');
            const itemSpecInput = document.getElementById('itemSpec');
            const itemBrandInput = document.getElementById('itemBrand');
            const itemUnitInput = document.getElementById('itemUnit');
            const itemMaterialPriceInput = document.getElementById('itemMaterialPrice');
            const itemLaborPriceInput = document.getElementById('itemLaborPrice');
            const itemQuantityInput = document.getElementById('itemQuantity');
            const itemOptions = document.getElementById('itemOptions');
            const itemListBody = document.getElementById('itemListBody');
            const totalMaterialCostEl = document.getElementById('totalMaterialCost');
            const totalLaborCostEl = document.getElementById('totalLaborCost');
            const totalCostEl = document.getElementById('totalCost');
            const emptyRow = document.getElementById('emptyRow');
            const customEntryCheckbox = document.getElementById('customEntry');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const editIndexInput = document.getElementById('editIndex');
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const cancelEditBtn = document.getElementById('cancelEditBtn');

            let addedItems = [];
            let itemPriceData = {};
            const allInputs = [itemNameInput, itemSpecInput, itemBrandInput, itemUnitInput, itemMaterialPriceInput, itemLaborPriceInput];

            // --- LẤY DỮ LIỆU TỪ FILE JSON ---
            try {
                const response = await fetch('unitprice.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                itemPriceData = await response.json();
                
                // Cập nhật giao diện khi tải thành công
                dataStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                dataStatus.classList.add('bg-green-100', 'text-green-800');
                dataStatus.textContent = 'Cơ sở dữ liệu đã sẵn sàng.';
                formFieldset.disabled = false; // Mở khóa form
                setTimeout(() => { dataStatus.style.opacity = 0; }, 2000);

            } catch (error) {
                console.error('Không thể tải file unitprice.json:', error);
                // Cập nhật giao diện khi có lỗi
                dataStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                dataStatus.classList.add('bg-red-100', 'text-red-800');
                dataStatus.textContent = 'Lỗi: Không thể tải được cơ sở dữ liệu đơn giá. Vui lòng đảm bảo file unitprice.json tồn tại và đặt cùng cấp với file index.html.';
                return; // Dừng thực thi
            }


            // --- CÁC HÀM XỬ LÝ ---
            Object.keys(itemPriceData).forEach(itemName => {
                const option = document.createElement('option');
                option.value = itemName;
                itemOptions.appendChild(option);
            });

            function setEditMode(isEditing) {
                if (isEditing) {
                    submitBtnText.textContent = 'Cập nhật';
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                    cancelEditBtn.classList.remove('hidden');
                    itemFullNameInput.required = false;
                } else {
                    submitBtnText.textContent = 'Thêm vào danh sách';
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                    cancelEditBtn.classList.add('hidden');
                    editIndexInput.value = '-1';
                    itemForm.reset();
                    customEntryCheckbox.checked = false;
                    customEntryCheckbox.dispatchEvent(new Event('change'));
                    itemFullNameInput.required = false;
                }
            }

            function renderList() {
                itemListBody.innerHTML = ''; 
                let grandTotalMaterial = 0;
                let grandTotalLabor = 0;

                exportCsvBtn.disabled = addedItems.length === 0;

                if (addedItems.length === 0) {
                    itemListBody.appendChild(emptyRow);
                } else {
                    addedItems.forEach((item, index) => {
                        const materialSubtotal = item.quantity * item.materialPrice;
                        const laborSubtotal = item.quantity * item.laborPrice;
                        const totalSubtotal = materialSubtotal + laborSubtotal;
                        grandTotalMaterial += materialSubtotal;
                        grandTotalLabor += laborSubtotal;

                        const row = document.createElement('tr');
                        
                        if (item.materialPrice === 0 || item.laborPrice === 0) {
                            row.className = 'table-row-animation bg-yellow-100 hover:bg-yellow-200';
                        } else {
                            row.className = 'table-row-animation hover:bg-slate-50';
                        }

                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm text-slate-700">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-slate-900">${item.name}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.spec}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.brand}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.unit}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.quantity.toLocaleString('vi-VN')}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.materialPrice.toLocaleString('vi-VN')}</td>
                            <td class="px-4 py-3 text-sm text-slate-700">${item.laborPrice.toLocaleString('vi-VN')}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-slate-900">${totalSubtotal.toLocaleString('vi-VN')}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center items-center space-x-2">
                                    <button class="edit-btn text-blue-500 hover:text-blue-700" data-index="${index}"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg></button>
                                    <button class="delete-btn text-red-500 hover:text-red-700" data-index="${index}"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                                </div>
                            </td>
                        `;
                        itemListBody.appendChild(row);
                    });
                }
                totalMaterialCostEl.textContent = `${grandTotalMaterial.toLocaleString('vi-VN')} VNĐ`;
                totalLaborCostEl.textContent = `${grandTotalLabor.toLocaleString('vi-VN')} VNĐ`;
                totalCostEl.textContent = `${(grandTotalMaterial + grandTotalLabor).toLocaleString('vi-VN')} VNĐ`;
            }

            // --- EVENT LISTENERS ---
            cancelEditBtn.addEventListener('click', () => setEditMode(false));

            customEntryCheckbox.addEventListener('change', function() {
                const isCustom = this.checked;
                allInputs.forEach(input => {
                    input.readOnly = !isCustom;
                    input.classList.toggle('bg-slate-200', !isCustom);
                    input.classList.toggle('bg-white', isCustom);
                    if(isCustom) input.placeholder = "Nhập...";
                });
                if (!isCustom) itemFullNameInput.dispatchEvent(new Event('input'));
            });

            itemFullNameInput.addEventListener('input', function() {
                if (customEntryCheckbox.checked) return;
                const selectedItem = itemPriceData[this.value];
                if (selectedItem) {
                    itemNameInput.value = selectedItem.name;
                    itemSpecInput.value = selectedItem.spec;
                    itemBrandInput.value = selectedItem.brand;
                    itemUnitInput.value = selectedItem.unit;
                    itemMaterialPriceInput.value = selectedItem.materialPrice;
                    itemLaborPriceInput.value = selectedItem.laborPrice;
                } else {
                    allInputs.forEach(input => input.value = '');
                }
            });

            itemForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                let materialPrice = parseFloat(itemMaterialPriceInput.value);
                let laborPrice = parseFloat(itemLaborPriceInput.value);

                const item = {
                    name: itemNameInput.value.trim(),
                    spec: itemSpecInput.value.trim(),
                    brand: itemBrandInput.value.trim(),
                    unit: itemUnitInput.value.trim(),
                    quantity: parseFloat(itemQuantityInput.value),
                    materialPrice: isNaN(materialPrice) ? 0 : materialPrice,
                    laborPrice: isNaN(laborPrice) ? 0 : laborPrice,
                };

                if (!item.name) {
                    alert("Vui lòng nhập Tên vật tư.");
                    itemNameInput.focus();
                    return;
                }
                if (isNaN(item.quantity) || item.quantity <= 0) {
                    alert("Vui lòng nhập Số lượng hợp lệ (lớn hơn 0).");
                    itemQuantityInput.focus();
                    return;
                }

                const currentIndex = parseInt(editIndexInput.value, 10);
                if (currentIndex > -1) {
                    addedItems[currentIndex] = item;
                } else {
                    addedItems.push(item);
                }
                
                renderList();
                setEditMode(false);
                itemFullNameInput.focus();
            });

            itemListBody.addEventListener('click', function(event) {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const index = parseInt(targetButton.dataset.index, 10);

                if (targetButton.classList.contains('delete-btn')) {
                    addedItems.splice(index, 1);
                    renderList();
                } else if (targetButton.classList.contains('edit-btn')) {
                    const item = addedItems[index];
                    
                    itemFullNameInput.value = '';
                    itemNameInput.value = item.name;
                    itemSpecInput.value = item.spec;
                    itemBrandInput.value = item.brand;
                    itemUnitInput.value = item.unit;
                    itemQuantityInput.value = item.quantity;
                    itemMaterialPriceInput.value = item.materialPrice;
                    itemLaborPriceInput.value = item.laborPrice;
                    
                    editIndexInput.value = index;
                    setEditMode(true);
                    
                    customEntryCheckbox.checked = true;
                    customEntryCheckbox.dispatchEvent(new Event('change'));

                    document.getElementById('main-content').scrollIntoView();
                }
            });

            exportCsvBtn.addEventListener('click', function() {
                if (addedItems.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "STT,Tên vật tư,Quy cách,Nhãn hiệu,Đơn vị,Số lượng,ĐG Vật tư,TT Vật tư,ĐG Nhân công,TT Nhân công,Tổng cộng\r\n";

                let totalMaterial = 0, totalLabor = 0;
                addedItems.forEach((item, index) => {
                    const materialSub = item.quantity * item.materialPrice;
                    const laborSub = item.quantity * item.laborPrice;
                    const totalSub = materialSub + laborSub;
                    totalMaterial += materialSub;
                    totalLabor += laborSub;
                    const row = [
                        index + 1, `"${item.name.replace(/"/g, '""')}"`, `"${item.spec.replace(/"/g, '""')}"`, `"${item.brand.replace(/"/g, '""')}"`,
                        item.unit, item.quantity, item.materialPrice, materialSub, item.laborPrice, laborSub, totalSub
                    ].join(',');
                    csvContent += row + "\r\n";
                });
                
                csvContent += `\r\n,,,,,,${totalMaterial},,${totalLabor},${totalMaterial + totalLabor}`;

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "bao_gia_vat_tu_chi_tiet.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // --- KHỞI TẠO ---
            renderList();
        });
    </script>
</body>
</html>
